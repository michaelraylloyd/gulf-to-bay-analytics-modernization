flowchart TD

    %% ======================================================
    %%   FABRIC SALES ANALYTICS — DQ RULES LINEAGE MAP
    %% ======================================================

    subgraph Inputs["Silver Inputs"]
        S1["sales_clean"]
        S2["products_clean"]
        S3["customers_clean"]
    end

    subgraph Rules["Expectation Rules (expectations.json)"]
        R1["Null Checks"]
        R2["Type Checks"]
        R3["Domain Checks"]
        R4["Foreign Key Checks"]
        R5["Custom Business Rules"]
    end

    subgraph Engine["DQ Engine"]
        E1["Rule Loader"]
        E2["Row Validator"]
        E3["Routing Logic"]
    end

    subgraph Outputs["DQ Outputs"]
        O1["Clean Output Tables<br/>(Silver → Gold)"]
        O2["Exception Tables<br/>dq_*_exceptions"]
        O3["DQ Summary Table"]
    end

    subgraph Gold["Gold Layer Consumers"]
        G1["fact_sales"]
        G2["dim_product"]
        G3["dim_customer"]
    end

    %% INPUTS → RULES
    S1 --> E1
    S2 --> E1
    S3 --> E1

    %% RULES → ENGINE
    R1 --> E2
    R2 --> E2
    R3 --> E2
    R4 --> E2
    R5 --> E2

    %% ENGINE FLOW
    E1 --> E2 --> E3

    %% ROUTING
    E3 --> O1
    E3 --> O2
    E2 --> O3

    %% GOLD CONSUMPTION
    O1 --> G1
    O1 --> G2
    O1 --> G3